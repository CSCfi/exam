# SPDX-FileCopyrightText: 2024 The members of the EXAM Consortium
#
# SPDX-License-Identifier: EUPL-1.2

name: Build

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres
        env:
          POSTGRES_DB: exam_test
          POSTGRES_USER: exam
          POSTGRES_PASSWORD: exam
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin
          cache: sbt

      - name: Set up SBT
        uses: sbt/setup-sbt@v1

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 24.x

      - name: Check REUSE compliance
        uses: fsfe/reuse-action@v6

      - name: Build UI and run tests
        run: |
          npm ci --ignore-scripts
          npm run check-format
          npm run check-lint
          npm run build
          npm test -- --no-watch

      - name: Build backend and run tests
        run: |
          sed -i 's/\/var\/log\/exam/logs/g' $GITHUB_WORKSPACE/conf/logback.xml
          sbt test

      - name: Generate SPDX Bill of Rights
        # Using pipx run ensures the file is created on the host filesystem
        # with the correct permissions for the upload step.
        run: pipx run reuse spdx -o bill-of-rights.spdx

      - name: Upload SBOM as CI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bill-of-rights
          path: bill-of-rights.spdx
          retention-days: 7

      - name: Publish Bill of Rights to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: bill-of-rights.spdx
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
