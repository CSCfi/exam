<!--
SPDX-FileCopyrightText: 2024 The members of the EXAM Consortium

SPDX-License-Identifier: EUPL-1.2
-->

<!--style>
    #questionBody.ng-invalid {
        border-color: transparent;
    }
    #editor.ng-invalid {
        border-color: transparent;
    }
</style-->
<div ngModelGroup="questionBody" id="questionBody">
    <xm-question-usage [examNames]="examNames" />
    <xm-question-basic-info
        [question]="question"
        [questionTypes]="questionTypes"
        [questionId]="question.id"
        (newText)="setText($event)"
        (newType)="setQuestionType($event)"
    />
    <div class="row mt-2">
        <div class="col-md-12">
            @if (question.type === 'EssayQuestion') {
                <!-- Evaluation -->
                <div class="xm-paragraph-title">{{ 'i18n_comments' | translate }}</div>
            } @else if (
                question.type === 'MultipleChoiceQuestion' ||
                question.type === 'WeightedMultipleChoiceQuestion' ||
                question.type === 'ClaimChoiceQuestion'
            ) {
                <!-- Multiple choices -->
                <div class="xm-paragraph-title">{{ 'i18n_question_options' | translate }}</div>
            }
        </div>
    </div>

    <!-- Type specific content -->
    @switch (question.type) {
        @case ('EssayQuestion') {
            <xm-essay-editor [question]="question" [lotteryOn]="lotteryOn" />
        }
        @case ('MultipleChoiceQuestion') {
            <xm-multiple-choice-editor
                [question]="question"
                [showWarning]="showWarning()"
                [lotteryOn]="lotteryOn"
                [allowOptionRemoval]="!isInPublishedExam"
                [multichoiceFeaturesOn]="multichoiceFeaturesOn()"
            />
        }
        @case ('WeightedMultipleChoiceQuestion') {
            <xm-multiple-choice-editor
                [question]="question"
                [showWarning]="showWarning()"
                [lotteryOn]="lotteryOn"
                [allowOptionRemoval]="!isInPublishedExam"
                [multichoiceFeaturesOn]="multichoiceFeaturesOn()"
            />
        }
        @case ('ClaimChoiceQuestion') {
            <xm-claim-choice-editor [question]="question" [lotteryOn]="lotteryOn" [showWarning]="showWarning()" />
        }
        @case ('LtiQuestion') {
            <div class="row mt-3">
                <div class="col-md-3">
                    {{ 'i18n_question_lti_id' | translate }}
                    <sup
                        ngbPopover="{{ 'i18n_question_lti_description' | translate }}"
                        popoverTitle="{{ 'i18n_instructions' | translate }}"
                        triggers="mouseenter:mouseleave"
                    >
                        <img src="/assets/images/icon_tooltip.svg" alt="" />
                    </sup>
                </div>
                <div class="col-md-9 pe-0">
                    <textarea
                        id="ltiId"
                        name="ltiId"
                        class="form-control"
                        rows="1"
                        [(ngModel)]="question.ltiId"
                        placeholder="{{ 'i18n_question_lti_id_instruction' | translate }}"
                    >
                    </textarea>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-3">
                    {{ 'i18n_evaluation_type' | translate }}
                </div>
                <div class="col-md-3">
                    <select
                        id="evaluationType"
                        name="evaluationType"
                        class="form-select w-75"
                        [ngModel]="question.defaultEvaluationType"
                        (ngModelChange)="updateEvaluationType($event)"
                        [disabled]="lotteryOn"
                        required="question.type == 'LtiQuestion'"
                    >
                        <option value="Points">{{ 'i18n_word_points' | translate }}</option>
                    </select>
                </div>
            </div>
        }
    }

    @if (
        question.type === 'MultipleChoiceQuestion' ||
        question.type === 'ClozeTestQuestion' ||
        question.defaultEvaluationType === 'Points' ||
        question.type === 'LtiQuestion'
    ) {
        <!-- Max score -->
        <div class="row mt-3">
            <div class="col-md-3">
                {{ 'i18n_max_score' | translate }}
            </div>
            <div class="col-md-2">
                <input
                    id="defaultMaxScore"
                    name="defaultMaxScore"
                    type="number"
                    lang="en"
                    class="form-control xm-numeric-input"
                    [(ngModel)]="question.defaultMaxScore"
                    [min]="0"
                    [max]="1000"
                    required
                    [disabled]="lotteryOn"
                />
            </div>
        </div>
    }

    <!-- Additional info -->
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="xm-paragraph-title">{{ 'i18n_additional_info' | translate }}</div>
        </div>
    </div>

    <!-- Exam owners -->
    <div class="row mt-3 align-items-center">
        <div class="col-md-3">
            {{ 'i18n_question_owners' | translate }}
            <sup
                ngbPopover="{{ 'i18n_question_owners_description' | translate }}"
                popoverTitle="{{ 'i18n_instructions' | translate }}"
                triggers="mouseenter:mouseleave"
            >
                <img src="/assets/images/icon_tooltip.svg" alt="" />
            </sup>
        </div>
        <div class="col-md-9">
            @if (isUserAllowedToModifyOwners()) {
                <div class="row">
                    <div class="col-md-3">
                        <div class="input-group">
                            <input
                                type="text"
                                name="questionOnwers"
                                class="form-control"
                                [(ngModel)]="newOwner.name"
                                [ngbTypeahead]="listQuestionOwners$"
                                [editable]="false"
                                [inputFormatter]="nameFormat"
                                [resultFormatter]="nameFormat"
                                (selectItem)="setQuestionOwner($event)"
                            />
                            <button
                                (click)="addQuestionOwner()"
                                [disabled]="!newOwner?.name"
                                class="btn btn-success input-group-text"
                            >
                                {{ 'i18n_add' | translate }}
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="ms-1 row" [hidden]="currentOwners.length !== 1">
                        {{ 'i18n_exam_last_owner_info' | translate }}
                    </div>
                    <div class="col-md-12 mt-3">
                        @for (user of currentOwners; track user.id) {
                            <div class="ms-1 row" [ngClass]="{ 'hover-grey': currentOwners.length !== 1 }">
                                <div class="row col-8">{{ user.firstName }} {{ user.lastName }} ({{ user.email }})</div>
                                <!-- Remove button -->
                                <button
                                    class="btn btn-danger btn-sm ms-1 w-auto m-1"
                                    (click)="removeOwner(user)"
                                    [hidden]="currentOwners.length === 1"
                                    [disabled]="removeOwnerDisabled(user)"
                                    [attr.aria-label]="user.firstName + ' ' + user.lastName"
                                >
                                    {{ 'i18n_remove' | translate }}
                                </button>
                            </div>
                        }
                    </div>
                </div>
            } @else {
                @for (user of currentOwners; track user.id) {
                    <div class="ms-1 row">
                        <div class="row col-8">{{ user.firstName }} {{ user.lastName }} ({{ user.email }})</div>
                    </div>
                }
            }
        </div>
    </div>

    <!-- Attachment -->
    <div class="row mt-3 align-items-center">
        <div class="col-md-3">
            {{ 'i18n_question_attachment' | translate }}
            <sup
                ngbPopover="{{ 'i18n_attachment_description' | translate }}"
                popoverTitle="{{ 'i18n_instructions' | translate }}"
                triggers="mouseenter:mouseleave"
            >
                <img src="/assets/images/icon_tooltip.svg" alt="" />
            </sup>
        </div>
        <div class="col-md-9" id="attachment">
            @if (showWarning()) {
                <div class="mt-1 edit-warning-container">
                    <i class="bi-exclamation-circle text-danger me-2"></i>
                    <span class="warning-text-small">{{ 'i18n_shared_question_property_info' | translate }}</span>
                </div>
            }
            <button class="btn btn-success" (click)="selectFile()">{{ 'i18n_attach_file' | translate }}</button>
            @if (question.attachment && !question.attachment?.removed) {
                <div class="make-inline ps-2">
                    @if (hasUploadedAttachment()) {
                        <!-- Uploaded -->
                        <a class="pointer attachment-link" (click)="downloadQuestionAttachment()">
                            <i class="bi-paperclip"></i> {{ question.attachment?.fileName }}
                        </a>
                    } @else {
                        <!-- Not yet uploaded -->
                        <span class="attachment-link">
                            <i class="bi-paperclip"></i> {{ question.attachment?.fileName }}
                            <small class="ps-2">{{ getFileSize() }}</small>
                        </span>
                    }
                    <span class="pointer remove-attachment" (click)="removeQuestionAttachment()">
                        <img src="/assets/images/icon_remove.svg" alt="{{ 'i18n_remove_attachment' | translate }}" />
                    </span>
                </div>
            }
        </div>
    </div>

    <!-- Instructions -->
    <div class="row mt-3">
        <div class="col-md-3">
            {{ 'i18n_question_instruction' | translate }}
            <sup
                ngbPopover="{{ 'i18n_question_instruction_description' | translate }}"
                popoverTitle="{{ 'i18n_instructions' | translate }}"
                triggers="mouseenter:mouseleave"
            >
                <img src="/assets/images/icon_tooltip.svg" alt="" />
            </sup>
        </div>
        <div class="col-md-9 pe-0">
            <textarea
                id="defaultInstructions"
                name="defaultInstructions"
                class="form-control"
                rows="3"
                [(ngModel)]="question.defaultAnswerInstructions"
                placeholder="{{ 'i18n_question_instruction' | translate }}"
            >
            </textarea>
        </div>
    </div>

    @if (question.type === 'EssayQuestion') {
        <!-- Evaluation criteria -->
        <div class="row mt-3">
            <div class="col-md-3">
                {{ 'i18n_exam_evaluation_criteria' | translate }}
                <sup
                    ngbPopover="{{ 'i18n_question_evaluation_criteria_description' | translate }}"
                    popoverTitle="{{ 'i18n_instructions' | translate }}"
                    triggers="mouseenter:mouseleave"
                >
                    <img src="/assets/images/icon_tooltip.svg" alt="" />
                </sup>
            </div>
            <div class="col-md-9 pe-0">
                <textarea
                    id="defaultEvaluationCriteria"
                    name="defaultEvaluationCriteria"
                    class="form-control"
                    rows="3"
                    [(ngModel)]="question.defaultEvaluationCriteria"
                    placeholder="{{ 'i18n_exam_evaluation_criteria' | translate }}"
                >
                </textarea>
            </div>
        </div>
    }

    @if (!collaborative) {
        <!-- Tags -->
        <xm-tag-picker [question]="question"></xm-tag-picker>
    }

    @if (sectionNames.length > 0) {
        <!-- Categories -->
        <div class="row mt-3">
            <div class="col-md-3">
                {{ 'i18n_added_to_sections' | translate }}
            </div>
            <div class="col-md-9">
                {{ sectionNames.join(', ') }}
            </div>
        </div>
    }
</div>
