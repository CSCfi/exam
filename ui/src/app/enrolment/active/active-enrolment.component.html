<!--
SPDX-FileCopyrightText: 2024 The members of the EXAM Consortium

SPDX-License-Identifier: EUPL-1.2
-->

@let reservation = enrolment().reservation;
@let eventConfig = enrolment().examinationEventConfiguration;
@let exam = enrolment().exam;
@let collabExam = enrolment().collaborativeExam;
<div class="active-enrolment-container">
    <div class="row align-items-center">
        <!-- calendar box -->
        @if (reservation || eventConfig) {
            <div class="col-auto">
                @if (reservation) {
                    <div class="student-enrolment-date-box">
                        {{ reservation!.startAt | date: 'dd' }}
                        <span class="month-name">{{
                            reservation!.startAt | date: 'MMM' | slice: 0 : 3 | uppercase
                        }}</span>
                    </div>
                }
                @if (eventConfig) {
                    <div class="student-enrolment-date-box">
                        {{ eventConfig!.examinationEvent.start | date: 'dd' }}
                        <span class="month-name">{{
                            eventConfig!.examinationEvent.start | date: 'MMM' | slice: 0 : 3 | uppercase
                        }}</span>
                    </div>
                }
            </div>
        }
        <!-- exam title n stuff -->
        <div class="col active-enrolment-heading">
            <div class="row">
                <div class="col">
                    @if (exam) {
                        <h2>
                            <a [routerLink]="['/enrolments', exam.id]" [queryParams]="{ code: exam.course?.code }">
                                {{ exam.name }}
                            </a>
                        </h2>
                    }
                    @if (collabExam) {
                        <h2>
                            <a>
                                {{ collabExam.name }}
                            </a>
                        </h2>
                    }

                    @if (exam?.anonymous || collabExam?.anonymous) {
                        <small>({{ 'i18n_anonymous_review' | translate }})</small>
                    }
                    @if (exam && exam.implementation === 'CLIENT_AUTH') {
                        <small>({{ 'i18n_examination_type_seb' | translate }})</small>
                    }
                    @if (exam && exam.implementation === 'WHATEVER') {
                        <small>({{ 'i18n_examination_type_home_exam' | translate }})</small>
                    }
                    <div class="row">
                        <div class="col">
                            @if (
                                (exam?.state === 'PUBLISHED' || collabExam?.state === 'PUBLISHED') &&
                                (reservation || eventConfig)
                            ) {
                                <span class="text-success">{{ 'i18n_state_ready' | translate }}</span>
                            }
                            @if (
                                (exam?.state === 'PUBLISHED' || collabExam?.state === 'PUBLISHED') &&
                                !reservation &&
                                !eventConfig
                            ) {
                                <span class="text-danger">{{ 'i18n_state_needs_reservation_title' | translate }}</span>
                            }
                            @if (exam?.state === 'STUDENT_STARTED') {
                                <span class="text-success">
                                    {{ 'i18n_state_started' | translate }}
                                </span>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-6">
            @if (exam) {
                <div>{{ 'i18n_course_name' | translate }}:</div>
            }

            @if (exam && exam.course) {
                <div>
                    <span class="exam-code">
                        <strong><xm-course-code [course]="exam.course"></xm-course-code></strong>
                    </span>
                    {{ exam.course.name }}
                </div>
            }
        </div>
        <div class="col-6">
            @if (exam) {
                <div>{{ 'i18n_teachers' | translate }}:</div>
            }
            @if (exam) {
                <div>
                    <xm-teacher-list [exam]="exam"></xm-teacher-list>
                </div>
            }
        </div>
    </div>
    @if (exam) {
        <div class="row mt-3">
            <div class="col-12">
                <button class="btn btn-outline-secondary" (click)="addEnrolmentInformation()">
                    <i class="bi bi-envelope"></i>
                    {{ 'i18n_student_edit' | translate }}
                </button>
            </div>
        </div>
    }
    @if (!reservation) {
        <div class="row mt-3">
            <div class="col">
                <div>{{ 'i18n_exam_validity' | translate }}:</div>
                <div>
                    {{ exam?.periodStart || collabExam.periodStart | date: 'dd.MM.yyyy' }}
                    &ndash;
                    {{ exam?.periodEnd || collabExam.periodEnd | date: 'dd.MM.yyyy' }}
                </div>
            </div>
        </div>
        @if (enrolment().reservationCanceled) {
            <div class="row mt-2 justify-content-start">
                <div class="col">
                    <div class="text-danger">
                        {{ 'i18n_exam_reservation_canceled' | translate }}
                    </div>
                </div>
            </div>
        }
    } @else {
        <div>
            <div class="row mt-3">
                <div class="col-md-3 col-lg-2">{{ 'i18n_exam_room' | translate }}:</div>
                @if (reservation.machine) {
                    <div class="col-md-9 col-lg-10">
                        {{ reservation.machine.name }}&nbsp;&nbsp;|&nbsp;&nbsp;{{ reservation.machine.room.name }} ({{
                            reservation.machine.room.roomCode
                        }})
                    </div>
                }
                @if (reservation.externalReservation) {
                    <div class="col-sm-12">
                        @if (reservation.externalReservation.orgName) {
                            <span>
                                <strong>{{ 'i18n_faculty_name' | translate | uppercase }}:</strong>
                                {{ reservation.externalReservation.orgName }} ({{
                                    reservation.externalReservation.orgCode
                                }})<br />
                            </span>
                        }
                        <strong>{{ 'i18n_room_campus' | translate | uppercase }}:</strong>
                        {{ reservation.externalReservation.campus }}<br />
                        <strong>{{ 'i18n_room_building_name' | translate | uppercase }}:</strong>
                        {{ reservation.externalReservation.buildingName }}<br />
                        <strong>{{ 'i18n_exam_room' | translate | uppercase }}:</strong>
                        {{ reservation.externalReservation.roomName }}
                        ({{ reservation.externalReservation.roomCode }})<br />
                        <strong>{{ 'i18n_exam_machine' | translate | uppercase }}:</strong>
                        {{ reservation.externalReservation.machineName }}<br />
                        {{ reservation.externalReservation.mailAddress.street }},
                        {{ reservation.externalReservation.mailAddress.zip }}&nbsp;
                        {{ reservation.externalReservation.mailAddress.city | uppercase }}
                    </div>
                }
                <div class="clearfix visible-xs"></div>
                <div class="clearfix visible-sm"></div>
                <div class="col-md-3 col-lg-2 mt-md-2 mt-3">{{ 'i18n_reservation' | translate }}:</div>
                <div class="col-md-9 col-lg-10 mt-md-2">
                    {{ reservation.startAt | applyDst | date: 'dd.MM.yyyy' }}
                    {{ enrolment().occasion?.startAt }} &ndash; {{ enrolment().occasion?.endAt }} ({{
                        enrolment().occasion?.tz
                    }})
                </div>
            </div>
            @if (getRoomInstruction()) {
                <div class="row mt-3">
                    <div class="col">
                        <button
                            class="btn btn-outline-secondary"
                            (click)="showGuide.set(!showGuide())"
                            (keydown.enter)="showGuide.set(!showGuide())"
                            [attr.aria-expanded]="showGuide()"
                        >
                            {{ 'i18n_room_guidance' | translate }}
                            <img
                                class="arrow_icon"
                                [hidden]="showGuide()"
                                alt=""
                                src="/assets/images/arrow_right.png"
                            />
                            <img
                                class="arrow_icon"
                                [hidden]="!showGuide()"
                                alt=""
                                src="/assets/images/arrow_down.png"
                            />
                        </button>
                    </div>
                    <div class="row mt-3" [ngbCollapse]="!showGuide()">
                        <div class="col-12">
                            {{ getRoomInstruction() }}
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    @if (exam && eventConfig && exam.implementation !== 'AQUARIUM') {
        <div>
            <div class="row mt-3 justify-content-start">
                <div>{{ 'i18n_examination_event' | translate }}:</div>
                <div>
                    {{ eventConfig?.examinationEvent?.start | date: 'dd.MM.yyyy HH:mm zzzz' }}
                </div>
            </div>
        </div>
    }

    @if (exam && eventConfig && exam.implementation !== 'AQUARIUM') {
        <div class="row mt-3 justify-content-start">
            <div class="col">
                <div class="row">
                    <div>{{ 'i18n_instructions' | translate }}:</div>
                    <div>
                        <span class="me-2">
                            {{ eventConfig.examinationEvent.description }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (exam && exam.implementation === 'CLIENT_AUTH') {
        <div class="row mt-3 justify-content-start">
            <div class="col">
                <div class="row">
                    <div>{{ 'i18n_seb_file' | translate }}:</div>
                    <div>
                        <span class="me-2">
                            <button (click)="downloadSebFile()" class="mt-1 btn btn-outline-secondary">
                                <strong>{{ 'i18n_download' | translate }}</strong>
                            </button>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    }
    @if (reservation && enrolment().optionalSections.length > 0) {
        <xm-optional-sections [selectedSections]="enrolment().optionalSections" [allSections]="exam.examSections" />
    }
    <div class="row mb-3 mt-2">
        <div class="col">
            <button
                class="btn btn-outline-secondary"
                [attr.aria-expanded]="showInstructions()"
                [hidden]="!exam?.enrollInstruction && !collabExam?.enrollInstruction"
                (click)="showInstructions.set(!showInstructions())"
                [attr.aria-expanded]="showInstructions()"
            >
                {{ 'i18n_view_instructions' | translate }}
                <i [hidden]="showInstructions()" class="bi bi-chevron-right"></i>
                <i [hidden]="!showInstructions()" class="bi bi-chevron-down"></i>
            </button>
        </div>

        <div class="col flex justify-content-end mb-3">
            <xm-active-enrolment-menu
                class="col"
                [enrolment]="enrolment()"
                (removed)="enrolmentRemoved($event)"
            ></xm-active-enrolment-menu>
        </div>
    </div>
    <div aria-live="polite" class="row mb-3 mt-3">
        @if (showInstructions()) {
            <div [xmMathJax]="exam?.enrollInstruction || collabExam?.enrollInstruction || ''"></div>
        }
    </div>
</div>
